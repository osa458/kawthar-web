import{a as ie}from"./chunk-INBEEENE.js";import{b as se}from"./chunk-BZZVLW4U.js";import{jsx as l,jsxs as b,Fragment as $e}from"react/jsx-runtime";import{useLexicalComposerContext as ve}from"@lexical/react/LexicalComposerContext";import{useLexicalEditable as Te}from"@lexical/react/useLexicalEditable";import{getTranslation as ce}from"@payloadcms/translations";import{Button as ae,Drawer as Oe,EditDepthProvider as Re,Form as Ee,formatDrawerSlug as Pe,FormSubmit as Le,RenderFields as je,ShimmerEffect as Me,useConfig as Ae,useDocumentForm as Je,useDocumentInfo as Ke,useEditDepth as ze,useServerFunctions as He,useTranslation as Ve}from"@payloadcms/ui";import{abortAndIgnore as A}from"@payloadcms/ui/shared";import{$getNodeByKey as J}from"lexical";import{deepCopyObjectSimpleWithoutReactComponents as K,reduceFieldsToValues as We}from"payload/shared";import v,{createContext as qe,useCallback as z,useEffect as I,useMemo as $,useRef as x}from"react";import{v4 as Ge}from"uuid";import{jsx as ye}from"react/jsx-runtime";import Fe from"bson-objectid";import{$applyNodeReplacement as De}from"lexical";import Ne from"react";import{addClassNamesToElement as ge}from"@lexical/utils";import _e from"bson-objectid";import{$applyNodeReplacement as xe,DecoratorNode as Ce}from"lexical";var _=class extends Ce{__cacheBuster;__fields;constructor({cacheBuster:e,fields:t,key:n}){super(n),this.__fields=t,this.__cacheBuster=e||0}static clone(e){return new this({cacheBuster:e.__cacheBuster,fields:e.__fields,key:e.__key})}static getType(){return"inlineBlock"}static importDOM(){return{}}static importJSON(e){return Se(e.fields)}static isInline(){return!1}canIndent(){return!0}createDOM(e){let t=document.createElement("span");return ge(t,e?.theme?.inlineBlock),t}decorate(e,t){return null}exportDOM(){let e=document.createElement("span");e.classList.add("inline-block-container");let t=document.createTextNode(this.getTextContent());return e.append(t),{element:e}}exportJSON(){return{type:"inlineBlock",fields:this.getFields(),version:1}}getCacheBuster(){return this.getLatest().__cacheBuster}getFields(){return this.getLatest().__fields}getTextContent(){return"Block Field"}isInline(){return!0}setFields(e,t){let n=this.getWritable();n.__fields=e,t||n.__cacheBuster++}updateDOM(){return!1}};function Se(s){return xe(new _({fields:{...s,id:s?.id||new _e.default().toHexString()}}))}var we=Ne.lazy(()=>import("./componentInline-QEXUNJU4.js").then(s=>({default:s.InlineBlockComponent}))),w=class extends _{static clone(e){return super.clone(e)}static getType(){return super.getType()}static importJSON(e){return Ie(e.fields)}decorate(e,t){return ye(we,{cacheBuster:this.getCacheBuster(),className:t.theme.inlineBlock??"LexicalEditorTheme__inlineBlock",formData:this.getFields(),nodeKey:this.getKey()})}exportJSON(){return super.exportJSON()}};function Ie(s){return De(new w({fields:{...s,id:s?.id||new Fe.default().toHexString()}}))}function M(s){return s instanceof w}var ue=qe({initialState:!1}),gt=()=>v.use(ue),_t=s=>{let{cacheBuster:e,className:t,formData:n,nodeKey:d}=s,[f]=ve(),c=Te(),{i18n:T,t:p}=Ve(),{createdInlineBlock:H,fieldProps:{featureClientSchemaMap:me,initialLexicalFormState:de,schemaPath:V},setCreatedInlineBlock:W,uuid:pe}=se(),{fields:C}=Je(),{getFormState:S}=He(),fe=ze(),q=x(!1),[a,O]=v.useState(()=>de?.[n.id]?.formState),G=x(!1),Q=x(e);I(()=>{G.current?(Q.current!==e&&O(!1),Q.current=e):G.current=!0},[e]);let[R,U]=v.useState(a?._components?.customComponents?.BlockLabel),[X,Y]=v.useState(a?._components?.customComponents?.Block),Z=Pe({slug:`lexical-inlineBlocks-create-${pe}-${n.id}`,depth:fe}),{toggleDrawer:h}=ie(Z,!0),be=x(null),{id:y,collectionSlug:F,getDocPreferences:D,globalSlug:N}=Ke(),{config:he}=Ae(),ke=`${V}.lexical_internal_feature.blocks.lexical_inline_blocks.${n.blockType}`,k=me.blocks?.[ke]?.[0],u=k.blockReferences?typeof k?.blockReferences?.[0]=="string"?he.blocksMap[k?.blockReferences?.[0]]:k?.blockReferences?.[0]:k?.blocks?.[0],ee=u?.fields??[];I(()=>{!q.current&&H?.getKey()===d&&(ee.length>2&&h(),W?.(void 0),q.current=!0)},[ee.length,H,d,W,h]);let te=z(()=>{f.update(()=>{J(d)?.remove()})},[f,d]),B=u?.labels?.singular?ce(u?.labels.singular,T):u?.slug,E=x(new AbortController),g=`${V}.lexical_internal_feature.blocks.lexical_inline_blocks.${u?.slug}.fields`;I(()=>{let o=new AbortController;return n&&!a&&(async()=>{let{state:r}=await S({id:y,collectionSlug:F,data:n,docPermissions:{fields:!0},docPreferences:await D(),documentFormState:K(C),globalSlug:N,initialBlockData:n,initialBlockFormState:n,operation:"update",readOnly:!c,renderAllFields:!0,schemaPath:g,signal:o.signal});if(r){let m=We(K(r),!0);f.update(()=>{let j=J(d);if(j&&M(j)){let le=m;le.blockType=n.blockType,j.setFields(le,!0)}}),O(r),U(r._components?.customComponents?.BlockLabel),Y(r._components?.customComponents?.Block)}})(),()=>{A(o)}},[S,f,d,c,g,y,n,a,F,N,D,C]);let ne=z(async({formState:o,submit:i})=>{A(E.current);let r=new AbortController;E.current=r;let{state:m}=await S({id:y,collectionSlug:F,docPermissions:{fields:!0},docPreferences:await D(),documentFormState:K(C),formState:o,globalSlug:N,initialBlockFormState:o,operation:"update",readOnly:!c,renderAllFields:!!i,schemaPath:g,signal:r.signal});return m?(i&&(U(m._components?.customComponents?.BlockLabel),Y(m._components?.customComponents?.Block)),m):o},[S,y,F,D,C,N,c,g]);I(()=>{let o=(i,r)=>Object.keys(r).some(m=>r[m]&&i[m]!==r[m].value);return()=>{a&&o(n,a)&&O(!1),A(E.current)}},[n,a]);let Be=z((o,i)=>{i.blockType=n.blockType,f.update(()=>{let r=J(d);r&&M(r)&&r.setFields(i,!0)})},[f,d,n]),P=$(()=>()=>l(ae,{buttonStyle:"icon-label",className:`${t}__removeButton`,disabled:!c,icon:"x",onClick:o=>{o.preventDefault(),te()},round:!0,size:"small",tooltip:p("lexical:blocks:inlineBlocks:remove",{label:B})}),[t,B,c,te,p]),oe=$(()=>()=>l(ae,{buttonStyle:"icon-label",className:`${t}__editButton`,disabled:!c,el:"button",icon:"edit",onClick:()=>{h()},round:!0,size:"small",tooltip:p("lexical:blocks:inlineBlocks:edit",{label:B})}),[t,B,c,p,h]),L=$(()=>({children:o,className:i})=>l("div",{className:[`${t}__container`,t+"-"+n.blockType,i].filter(Boolean).join(" "),ref:be,children:o}),[t,n.blockType]),re=$(()=>R?()=>R:()=>l("div",{children:u?.labels?ce(u?.labels.singular,T):""}),[R,u?.labels,T]);return u?b(Ee,{beforeSubmit:[async({formState:o})=>await ne({formState:o,submit:!0})],disableValidationOnSubmit:!0,el:"div",fields:u?.fields,initialState:a||{},onChange:[ne],onSubmit:(o,i)=>{Be(o,i),h()},uuid:Ge(),children:[l(Re,{children:l(Oe,{className:"",slug:Z,title:p(`lexical:blocks:inlineBlocks:${n?.id?"edit":"create"}`,{label:B??p("lexical:blocks:inlineBlocks:label")}),children:a?b($e,{children:[l(je,{fields:u?.fields,forceRender:!0,parentIndexPath:"",parentPath:"",parentSchemaPath:g,permissions:!0,readOnly:!c}),l(Le,{programmaticSubmit:!0,children:p("fields:saveChanges")})]}):null})}),X?l(ue,{value:{EditButton:oe,initialState:a,InlineBlockContainer:L,Label:re,nodeKey:d,RemoveButton:P},children:X}):b(L,{children:[a?l(re,{}):l(Me,{height:"15px",width:"40px"}),c?b("div",{className:`${t}__actions`,children:[l(oe,{}),l(P,{})]}):null]})]}):b(L,{className:`${t}-not-found`,children:[b("span",{children:["Error: Block '",n.blockType,"' not found"]}),c?l("div",{className:`${t}__actions`,children:l(P,{})}):null]})};export{gt as a,_t as b,w as c,Ie as d,M as e};
//# sourceMappingURL=chunk-52JG5GGJ.js.map
